
var fs = require('fs');
var url = require('../lib/url');
var request = require('request');
var AdmZip = require('adm-zip');


module.exports = function(appId, ipaPath, callback) {

    url(appId, function(){}, function(fileUrl, iconUrl, short) {
        console.log('will upload ipa: '.green + ipaPath + ' to '.green + (fileUrl+'').underline);
        var data = fs.readFileSync(ipaPath);
        var options = {
            url: fileUrl,
            method: "PUT",
            body: data
        };

        function onRep(error, response, body) {

            if (!error && response.statusCode == 200) {
                console.log('Upload file success!'.green);
                callback(0);
            } else {
                callback(1, error.toString());
            }
        }
        request(options, onRep);


//        var zip = new AdmZip(ipaPath);
//        var zipEntries = zip.getEntries();
//
//        var dataIcon = null;
//        zipEntries.forEach(function(zipEntry) {
//            if (zipEntry.entryName == "iTunesArtwork") {
//                dataIcon = zipEntry.data;
//            }
//        });
//
//
//        console.log('will upload icon: '.green + ' to '.green + (iconUrl+'').underline);
//
//        var optionsIcon = {
//            url: iconUrl,
//            method: "PUT",
//            body: dataIcon
//        };
//
//        function onRepIcon(error, response, body) {
//
//            if (!error && response.statusCode == 200) {
//                console.log('Upload icon success!'.green);
//                callback(0);
//            } else {
//                callback(1, error.toString());
//            }
//        }
//        request(optionsIcon, onRepIcon);


    });
}